rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin of a club
    function isClubAdmin(ownerUid) {
      let clubProfile = get(/databases/$(database)/documents/club_profiles/$(ownerUid));
      return request.auth.uid == ownerUid || (request.auth.uid in clubProfile.data.admins);
    }

    // PUBLIC COLLECTIONS
    match /club_profiles/{ownerUid} {
      allow read: if true;
      // Only the owner or an existing admin can modify the profile (e.g., to add other admins)
      allow write: if request.auth != null && isClubAdmin(ownerUid);
    }

    // This seems to be a global news collection, separate from club news.
    // Keep its rules simple for now.
    match /news/{newsId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // CLUB-SPECIFIC DATA
    match /clubs/{ownerUid} {
      // The main club document can be read by anyone, but only written by an admin
      allow read: if true;
      allow write: if request.auth != null && isClubAdmin(ownerUid);

      // Subcollections within a club
      match /competitions/{compId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);

        match /standings/{teamId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }

        match /rounds/{roundId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);

          match /matches/{matchId} {
            allow get, list: if true;
            allow write: if request.auth != null && isClubAdmin(ownerUid);
          }
        }
      }

      match /teams/{teamId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      match /news/{newsId} {
        allow read: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      match /videos/{videoId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      // Players subcollection needs to be explicitly defined for rules to apply
      match /players/{playerId} {
         allow get, list: if true;
         allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      match /seasons/{seasonId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);

        match /roster/{playerId} {
          allow get, list: if true;
        }
      }
    }

    // USER-SPECIFIC DATA
          match /teams/{teamId} {
        allow get, list: if request.auth.uid == ownerUid;
      }
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
