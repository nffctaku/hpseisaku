rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // CLUB PROFILES - Allow read for authenticated users, write for owners
    match /club_profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // USER-SPECIFIC DATA - Full access for owners
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 利用規約同意状態（本人のみ）
    match /user_consents/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // CLUB DATA - Allow read for authenticated users, write for club owners
    match /clubs/{clubId} {
      // Allow read access for authenticated users
      allow read: if request.auth != null;
      
      // Club metadata - write only for club owners
      allow write: if request.auth != null && request.auth.uid == clubId;

      // Team categories
      match /team_categories/{categoryId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }
      
      // Competitions
      match /competitions/{competitionId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;

        // Competition settings (templates etc.)
        match /settings/{settingId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }

        // Standings
        match /standings/{teamId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }
        
        // Competition rounds and matches
        match /rounds/{roundId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
          
          match /matches/{matchId} {
            allow read: if request.auth != null;
            allow write: if request.auth != null && request.auth.uid == clubId;

            // Match events
            match /events/{eventId} {
              allow read: if request.auth != null;
              allow write: if request.auth != null && request.auth.uid == clubId;
            }
          }
        }
      }
      
      // Teams and players
      match /teams/{teamId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
        
        match /players/{playerId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }

        // Transfers
        match /transfers/{transferId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }

        // Staff
        match /staff/{staffId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }
      }
      
      // Seasons and roster
      match /seasons/{seasonId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
        
        match /roster/{playerId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }
      }

      // News
      match /news/{newsId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }

      // Videos
      match /videos/{videoId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }
      
      // Friendly matches
      match /friendly_matches/{matchId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }

      // Public match index (for fast match listing/search)
      match /public_match_index/{indexId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }

      // Legacy matches collection
      match /matches/{matchId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;

        match /events/{eventId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == clubId;
        }
      }
      
      // Public player stats cache
      match /public_player_stats_cache/{playerId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }

      match /{document=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == clubId;
      }
    }

    // Global collections (if any)
    match /matches/{matchId} {
      allow read: if request.auth != null;
      allow write: if false; // No writes to global matches
    }
  }
}
