rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin of a club
    function isClubAdmin(ownerUid) {
      let clubProfile = get(/databases/$(database)/documents/club_profiles/$(ownerUid));
      return request.auth.uid == ownerUid || (
        clubProfile != null &&
        clubProfile.exists() &&
        clubProfile.data.admins != null &&
        (request.auth.uid in clubProfile.data.admins)
      );
    }

    // PUBLIC COLLECTIONS
    match /club_profiles/{ownerUid} {
      // 公開プロフィールは誰でも読める
      allow read: if true;
      // 変更できるのはオーナーか既存の管理者
      allow write: if request.auth != null && isClubAdmin(ownerUid);
    }

    // グローバルなニュース
    match /news/{newsId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // CLUB-SPECIFIC DATA
    match /clubs/{ownerUid} {
      // クラブ本体ドキュメント
      allow read: if true;
      allow write: if request.auth != null && isClubAdmin(ownerUid);

      // 大会
      match /competitions/{compId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);

        match /settings/{docId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }

        match /standings/{teamId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }

        match /rounds/{roundId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);

          match /matches/{matchId} {
            allow get, list: if true;
            allow write: if request.auth != null && isClubAdmin(ownerUid);

            match /events/{eventId} {
              allow get, list: if true;
              allow write: if request.auth != null && isClubAdmin(ownerUid);
            }
          }
        }
      }

      // チーム
      match /teams/{teamId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);

        // 各チーム配下の選手
        match /players/{playerId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }

        // 各チーム配下のスタッフ
        match /staff/{staffId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }

        // 各チーム配下の移籍ログ
        match /transfers/{transferId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }
      }

      match /team_categories/{categoryId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      // 単発試合（親善/練習）
      match /friendly_matches/{matchId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);

        match /events/{eventId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }
      }

      // クラブニュース
      match /news/{newsId} {
        allow read: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      // 動画
      match /videos/{videoId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);
      }

      // シーズン（旧ロスター用。今後使うならここを拡張）
      match /seasons/{seasonId} {
        allow get, list: if true;
        allow write: if request.auth != null && isClubAdmin(ownerUid);

        match /roster/{playerId} {
          allow get, list: if true;
          allow write: if request.auth != null && isClubAdmin(ownerUid);
        }
      }
    }

    // USER-SPECIFIC DATA
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 利用規約同意状態（本人のみ）
    match /user_consents/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
